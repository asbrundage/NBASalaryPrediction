---
title: "NBA Salary Prediction"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup

```{r cars}
library(tidyverse)
library(readxl)
library(NBAloveR)
library(knitr)
library(corrplot)
library(stargazer)

salary <- read.csv("C:/Users/asbru/Documents/GitHub/NBASalaryPrediction/data/NBA metrics plus salary_with var notes.csv")
injuries <- read.csv("C:/Users/asbru/Documents/GitHub/NBASalaryPrediction/data/injuries.csv")
capspace <- read_excel("C:/Users/asbru/Documents/GitHub/NBASalaryPrediction/data/TeamCapSpace.xlsx")
allnbateam <- read_excel("C:/Users/asbru/Documents/GitHub/NBASalaryPrediction/data/AllNBATeam.xlsx")
awards<- read_excel("C:/Users/asbru/Documents/GitHub/NBASalaryPrediction/data/awards-consolidated.xlsx")
salary2016<- read.csv("C:/Users/asbru/Documents/GitHub/NBASalaryPrediction/data/2016 Salaries.csv")

```

## Data Prep

```{r pressure, echo=FALSE}

injuriessum <-
  injuries %>%
  filter(!is.na(Team)) %>%
  count(Relinquised) %>%
  rename("numberofinjuries" = "n") 

awardtotal <-
  awards %>%
  # filter(Award == "MVP") %>%
  count(PLAYER ) %>%
  rename("numberofawards" = "n") 
  
mvp <-
  awards %>%
  filter(Award == "MVP") %>%
  count(PLAYER ) %>%
  rename("mvp" = "n") 
roty <-
  awards %>%
  filter(Award == "ROTY") %>%
  count(PLAYER ) %>%
  rename("roty" = "n") 
dpoty <-
  awards %>%
  filter(Award == "DPOTY") %>%
  count(PLAYER ) %>%
  rename("dpoty" = "n") 
sixth <-
  awards %>%
  filter(Award == "Sixth Man") %>%
  count(PLAYER ) %>%
  rename("sixthman" = "n") 

finalsmvp <-
  awards %>%
  filter(Award == "Finals MVP") %>%
  count(PLAYER ) %>%
  rename("finalsmvp" = "n") 

Seasons <- 
  players %>%
  group_by(Player) %>%
  top_n(1,Year) %>%
  mutate(numberofseasons = Year - RookieYear) 

prioriyearsal <-
  salary2016 %>%
  group_by(`Player.Name`) %>%
  summarise(PriorYear = sum(`Salary.in..`))

salarycombined <-
  salary %>%
  left_join(injuriessum, by = c("Player" = "Relinquised")) %>%
  left_join(Seasons, by = c("Player" = "Player")) %>%
  left_join(awardtotal, by = c("Player" = "PLAYER")) %>%
  left_join(mvp, by = c("Player" = "PLAYER")) %>%
  left_join(roty, by = c("Player" = "PLAYER")) %>%
  left_join(dpoty, by = c("Player" = "PLAYER")) %>%
  left_join(sixth, by = c("Player" = "PLAYER")) %>%
  left_join(finalsmvp, by = c("Player" = "PLAYER")) %>%
  left_join(prioriyearsal, by = c("Player" = "Player.Name")) %>%
  left_join(allnbateam, by = c("Player" = "Player")) 
# %>%
#   mutate(highschool = str_detect(players$PreDraftTeam, "School"))

salarycombined <-
  salarycombined %>%
  mutate(highschool = str_detect(PreDraftTeam, "School")) %>%
  mutate(international = str_detect(NBA_Country,"USA"))

salarycombined$highschool <- as.integer(as.logical(salarycombined$highschool))
salarycombined$international <- as.integer(as.logical(salarycombined$international))

  # filter("Year" =="RookieYear") 
  # kable()
# seasons
# kable()


```

##Subset Data Based on Player Position - Players without salary from prior year removed

```{r}

allpositions <-
  salarycombined %>%
  mutate_at(vars(mvp,roty,dpoty,sixthman,finalsmvp,Salary,Guaranteed,numberofawards,numberofinjuries,highschool,international), ~replace_na(., 0)) %>%
  drop_na(PriorYear,X3PAr)

allpositions$exp <-allpositions$Age.x - allpositions$numberofseasons - 5
#run the below line individually
allpositions$expsqd <- allpositions$exp^2 

# 
# center <-
#   allpositions %>%
#   filter(Pos.x == "C") 
# powerforward <-
#   allpositions %>%
#   filter(Pos.x == "PF")
# shootingguard <-
#   allpositions %>%
#   filter(Pos.x == "SG")
# pointguard <-
#   allpositions %>%
#   filter(Pos.x == "PG")
# smallforward <-
#   allpositions %>%
#   filter(Pos.x == "SF")


```

##Correlation Matrix

```{r}
# 
# salarynumeric <- select(salarycombined,c(mvp,roty,dpoty,sixthman,finalsmvp,Salary,Guaranteed,numberofawards,numberofinjuries))
# 
# salarynumeric[is.na(salarynumeric)] = 0

correlationall <- 
  select(allpositions,-c(Player,NBA_Country,Signed.Using,Pos.x,Tm,Pos.y,HT,WT,Teams,PreDraftTeam,Draft.Status,Nationality,Age.y))
M <- 
  cor(correlationall)
# png(file="corr.png", res=300, width=4500, height=4500)
corrplot(M, method = "shade", number.cex = 1, tl.cex = 1, title = "All Positions", mar=c(0,0,1,0))


```


##Model

```{r}
Modelall <- lm(Salary
              ~ numberofseasons 
              + exp
              + expsqd
              + MP
              + PER
              + VORP
              + numberofinjuries
              # + Tot
              + PriorYear
              # + highschool
              , data = allpositions)

# Modelcenter <- lm(Salary
#               ~ VORP 
#               + PriorYear
#               + dpoty
#               + MP
#               + DWS
#               + numberofinjuries
#               , data = center)
# 
# Modelpf <- lm(Salary
#               ~ VORP 
#               + PriorYear
#               + numberofawards
#               + numberofseasons
#               , data = powerforward)
# 
# Modelsg <- lm(Salary
#               ~ VORP
#               + PriorYear
#               + WS
#               + AST.
#               + numberofseasons
#               , data = shootingguard)
# 
# Modelpg <- lm(Salary
#               ~ VORP 
#               + PriorYear
#               + numberofseasons
#               + MP
#               + mvp
#               , data = pointguard)
# 
# Modelsf <- lm(Salary
#               ~ VORP
#               + PriorYear
#               + OWS
#               + WS
#               + numberofseasons
#               , data = smallforward)


summary(Modelall)
# summary(Modelcenter)
# summary(Modelpf)
# summary(Modelsg)
# summary(Modelpg)
# summary(Modelsf)
# stargazer(Modelall,Modelcenter, type = "html")

```
